#!/usr/bin/env python3
from subprocess import run

resolutions = [32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448, 480, 512]
inkscape_has_o = run('inkscape -o /tmp/nope.png', shell=True, check=False).returncode == 0
formats = {
    'svg': f'inkscape -w $(1) -h $(1) $$< {"-o" if inkscape_has_o else "-e"} tmp/$$*-$(1).png 2>/dev/null',
    'png': 'convert $$< -resize $(1)x$(1) tmp/$$*-$(1).png',
}

contents = ''
with open('Makefile', 'r') as f:
    for line in f.readlines():
        contents += line
        if line.startswith('# auto-generated block'):
            break

contents += '\nRES = ' + ' '.join(map(str, resolutions)) + '\n'

for e,c in formats.items():
    contents += f'\ndefine {e}\n'
    contents += f'tmp/%-$(1).png: html/img/%.{e}\n'
    contents += f'\t{c}\n'
    contents += 'endef\n\n'
    contents += f'$(foreach r,$(RES),$(eval $(call {e},$(r))))\n'

contents += '\ntmp/%.ico: $(foreach r,$(RES),tmp/%-$(r).png)' + '\n'
contents += '\tconvert tmp/$*-*.png $@\n'

with open('Makefile', 'w') as f:
    f.write(contents)
