#!/usr/bin/env python3
from subprocess import run

resolutions = [32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448, 480, 512]
inkscape_has_o = run('inkscape -o /tmp/nope.png', shell=True, check=False).returncode == 0
formats = {
    'svg': lambda r: f'inkscape -w {r} -h {r} $< {"-o" if inkscape_has_o else "-e"} tmp/$*-{r}.png 2>/dev/null',
    'png': lambda r: f'convert $< -resize {r}x{r} tmp/$*-{r}.png',
}

contents = ''
with open('Makefile', 'r') as f:
    for line in f.readlines():
        contents += line
        if line.startswith('# auto-generated block'):
            break

contents += '\nRES = ' + ' '.join(map(str, resolutions)) + '\n'

for e,c in formats.items():
    for r in resolutions:
        contents += f'\ntmp/%-{r}.png: html/img/%.{e}\n'
        contents += '\t' + c(r) + '\n'
contents += '\ntmp/%.ico: $(foreach r,$(RES),tmp/%-$(r).png)' + '\n'
contents += '\tconvert tmp/$*-*.png $@\n'

with open('Makefile', 'w') as f:
    f.write(contents)
