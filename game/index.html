<!DOCTYPE html>
<html lang="de" id="">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#030303">
    <title>Spiel zur Collatz-Folge</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <script src="../collatz.js"></script>
    <header class="center-children" style="position: absolute; left: 0; right: 0;">
        <h1 style="font-size: 40pt; text-align: center;">score<br/><span id="score" style="color: #00ffa1;">0</span></h1>
    </header>
    <div style="height: 100%; width: 50%; float: left; background: #1a1a1a;" class="center-children">
        <div>
            <h1 style="font-size: 60pt; margin: 0;" id="num1text"></h1>
            <h1 style="margin: 0; text-align: center; font-size: 35pt;" id="num1text-steps"></h1>
        </div>
    </div>
    <div style="height: 100%; width: 50%; float: right; background: transparent;" class="center-children">
        <div>
            <h1 onclick="go_next(true)" style="margin: 0; text-align: center;">
                <span style="text-decoration: none;" class="text-button">▲<br/>mehr</span>
            </h1>
            <br/>
            <h1 style="font-size: 60pt; margin: 0; text-align: center;" id="num2text"></h1>
            <br/>
            <h1 onclick="go_next(false)" style="margin: 0; text-align: center;">
                <span style="text-decoration: none;" class="text-button">weniger<br/>▼</span>
            </h1>
        </div>
    </div>
    <script>
        var last_random;
        function random(max) {
            var result;
            do result = Math.floor(Math.random() * max);
            while(result == last_random);
            last_random = result;
            return result;
        }

        var score = 0;

        var num1 = random(1000);
        var num2 = random(1000);

        var fail_body;

        async function update_text(element, num) {
            num = num + 1;
            var i = 0;
            const i1 = Math.round(120);
            const text1counter = setInterval(() => {
                i += 1;
                const i2 = (i / i1) * (2 - (i / i1));
                const i3 = Math.round(num * i2);
                if(num !== i3) element.innerHTML = i3;
                if(i === i1) clearInterval(text1counter);
            }, 4000 * i / num ** 2);
        }

        function update_all_texts() {
            update_text(document.getElementById("num1text"), num1);
            update_text(document.getElementById("num1text-steps"), collatz_steps(num1));
            update_text(document.getElementById("num2text"), num2);
            document.getElementById("score").innerHTML = score;
        }

        function go_next(higher) {
            // Best reference to LoL, LOL
            const prev = Number(document.getElementById("num1text-steps").innerHTML);
            const curr = collatz_steps(num2);
            if(higher && prev > curr || !higher && prev < curr) {
                fail(score);
                return;
            }
            num1 = num2;
            num2 = random(1000);
            score += 1;
            update_all_texts();
        }

        async function fail(score) {
            const orig_body = document.body.innerHTML;

            document.body.innerHTML = fail_body;
            document.body.classList.add("center-children");

            document.getElementById("again").onclick = () => {
                document.body.innerHTML = orig_body;
                document.body.classList.remove("center-children");

                score = 0;
                num1 = random(1000);
                num2 = random(1000);

                update_all_texts();
            };

            update_text(document.getElementById("score"), score);
        }

        collatz_init("../collatz.wasm").then(async () => {
            update_all_texts();
            fail_body = await (await fetch("fail.htm")).text();
        });
    </script>
</body>
</html>
