test {
        %APPEND CPPFLAGS -Isrc
        %CPPC testexe src/collatz.cc test/steps_test.cc
        !./testexe
}

wasm {
        %SET CPPC clang++
        %APPEND CPPFLAGS --target=wasm32 -flto -nostdlib -Wl,--no-entry -Wl,--export-all -Wl,--lto-O3
        %CPPC collatz.wasm src/collatz.cc
}

benchmark {
        %SET CPPFLAGS -O3 -flto -nostdlib -Wl,--no-entry -Wl,--export-all -Wl,--lto-O3 -Isrc

        !echo 'Benchmarking em++'
        %SET CPPC em++
        %CPPC c.wasm test/benchmark.cc src/collatz.cc
        !time sh -c 'wasmer c.wasm -i main 0 0 >/dev/null'

        !echo 'Benchmarking clang++'
        %SET CPPC clang++
        %CPPC c.wasm --target=wasm32 test/benchmark.cc src/collatz.cc
        !time sh -c 'wasmer c.wasm -i main 0 0 >/dev/null'

        !rm -f c.wasm
}

all (test benchmark wasm) {}
